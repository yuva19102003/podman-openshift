# -----------------------------
# Stage 1 - Build Go Binary
# -----------------------------
FROM golang:1.23-alpine AS builder

WORKDIR /build

# Copy dependency files first for better caching
COPY go.mod go.sum* ./

# Download dependencies
RUN go mod download

# Copy source code
COPY main.go .
COPY static ./static

# Build static binary with optimizations
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -ldflags="-w -s" -o app main.go

# -----------------------------
# Stage 2 - Runtime Image
# -----------------------------
FROM alpine:3.20

WORKDIR /app

# Install ca-certificates for HTTPS and tzdata for timezone support
RUN apk add --no-cache ca-certificates tzdata && \
    addgroup -g 1001 appgroup && \
    adduser -D -u 1001 -G appgroup appuser

# Copy binary from builder
COPY --from=builder /build/app .

# Copy static files only
COPY --from=builder /build/static ./static

# Create data directory structure for PV mount
# Note: .env and config.json will be mounted from ConfigMaps/Secrets
# Note: /app/data will be mounted as PersistentVolume
RUN mkdir -p /app/data/log && \
    chown -R appuser:appgroup /app && \
    chmod -R 755 /app && \
    chmod -R 777 /app/data

# OpenShift/Podman compatibility:
# Allow arbitrary UIDs to write to necessary directories
RUN chmod -R g+rwX /app /app/data && \
    chgrp -R 0 /app /app/data && \
    chmod -R g=u /app /app/data

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1

EXPOSE 8080

# Labels for better image management
LABEL maintainer="OpenShift Team" \
      version="1.1.0" \
      description="OpenShift Go Monolith Application" \
      io.openshift.expose-services="8080:http" \
      io.k8s.description="OpenShift Go Monolith Demo Application" \
      io.k8s.display-name="Go Monolith" \
      io.openshift.tags="golang,monolith,demo"

# Run as non-root user (OpenShift/Podman best practice)
USER 1001

CMD ["./app"]